<app-navbar [showProfile]="false" [showFilters]="false" [showSearchbar]="false" />

<!-- Filters and summary -->
<section class="w-full bg-gray-100 px-6 py-6">
  <div class="mx-auto max-w-6xl">
    <h1 class="text-xl font-semibold text-gray-900">Compras</h1>

    <div class="mt-5 flex flex-wrap items-center gap-4">
      <!-- Search -->
      <div class="relative">
        <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-gray-400">
          <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
        </span>

        <input
          type="text"
          placeholder="Busca por compra, marca y más..."
          class="h-10 w-85 max-w-full rounded-full border border-gray-300 bg-white pl-10 pr-4 text-sm text-gray-800 placeholder:text-gray-400 shadow-sm outline-none focus:border-gray-400 focus:ring-2 focus:ring-gray-200"
          [value]="productFilters().search"
          (input)="onSearch($event)"
        />
      </div>

      <!-- Filters -->
      <div class="flex items-center gap-6">
        <!-- CATEGORÍA FILTER -->
        <div class="relative">
          <button
            type="button"
            class="inline-flex items-center gap-2 text-sm text-gray-800 hover:text-gray-900"
            (click)="showCategoryFilter = !showCategoryFilter"
          >
            <span>{{ selectedCategory() }}</span>
            <svg
              viewBox="0 0 24 24"
              class="h-4 w-4 transition-transform"
              [class.rotate-180]="showCategoryFilter"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
            </svg>
          </button>

          @if (showCategoryFilter) {
            <div class="absolute left-0 mt-2 w-52 rounded-xl border border-gray-200 bg-white shadow-lg z-30">
              <ul class="py-2 text-sm">
                @for (cat of categories; track cat) {
                  <li class="px-4 py-2 cursor-pointer hover:bg-gray-100" (click)="selectCategory(cat)">
                    {{ cat }}
                  </li>
                }
              </ul>
            </div>
          }
        </div>

        <!-- FECHA FILTER -->
        <div class="relative">
          <button
            type="button"
            class="inline-flex items-center gap-2 text-sm text-gray-800 hover:text-gray-900"
            (click)="showDateFilter = !showDateFilter"
          >
            <span>{{ selectedDateLabel() }}</span>
            <svg
              viewBox="0 0 24 24"
              class="h-4 w-4 transition-transform"
              [class.rotate-180]="showDateFilter"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
            </svg>
          </button>

          @if (showDateFilter) {
            <div class="absolute left-0 mt-2 w-52 rounded-xl border border-gray-200 bg-white shadow-lg z-30">
              <ul class="py-2 text-sm">
                @for (opt of dateOptions; track opt.value) {
                  <li class="px-4 py-2 cursor-pointer hover:bg-gray-100" (click)="selectDate(opt.value)">
                    {{ opt.label }}
                  </li>
                }
              </ul>
            </div>
          }
        </div>

        <span class="mx-2 h-5 w-px bg-gray-300"></span>

        @let plural = totalFilteredOrders() > 1;
        <span class="text-sm text-gray-900">
          {{ totalFilteredOrders() }} producto{{ plural ? 's' : '' }} comprado{{ plural ? 's' : '' }}
        </span>
      </div>
    </div>
  </div>
</section>

<!-- PRODUCTOS INFORMATION -->
<section class="w-full bg-gray-100 py-4">
  @for (shop of shopsGroupedByDate(); track shop.date) {
    <div class="mx-auto max-w-6xl mb-6 overflow-hidden rounded-2xl bg-white border border-gray-200">
      <!-- Header -->
      <div class="px-6 py-3 border-b border-gray-300">
        <h2>
          {{ shop.date | date: "d 'de' MMMM 'de' y" : 'UTC' : 'es-CO' }}
        </h2>
      </div>

      <!-- Productos -->
      @for (order of shop.orders; track order) {
        @for (prod of order.items; track prod) {

          <!-- ✅ DESKTOP/TABLET (md+) - TU DISEÑO ORIGINAL, SIN CAMBIOS -->
          <div class="hidden md:grid grid-cols-9 gap-1 px-6 py-6 border-b border-gray-200 last:border-b-0">
            <div class="col-span-1">
              <img
                class="rounded-md max-h-25 object-cover"
                [src]="prod.product.images.at(0)"
                alt="Avatar"
              />
            </div>

            <div class="col-span-4 flex flex-col">
              <h3 class="text-green-600">{{ order.status | titlecase }}</h3>
              @if (order.status === 'pending' || order.status?.toLowerCase() === 'pendiente') {
                <p>La compra está siendo procesada</p>
              } @else if (order.status === 'enviado') {
                <p>Su producto fue enviado</p>
              } @else if (order.status === 'entregado') {
                <p>Su producto fue entregado el 22 de enero de 2025</p>
              }
              <p class="mt-2 text-gray-400">
                {{ prod.product.description | titlecase }}-{{ prod.quantity }}
              </p>
              <p>Talla {{ prod.size }}</p>
            </div>

            <div class="col-span-2">
              @if (order.status === 'enviado') {
                <p>
                  N° Guía:
                  <a
                    class="btn-link text-blue-400 decoration-0"
                    href="https://www.servientrega.com/wps/portal/rastreo-envio"
                    target="_blank"
                    >{{ order.numGuia | uppercase }}</a
                  >
                </p>
              } @else {
                <p>N° Guía: Por confirmar</p>
              }
              <button class="btn mt-2 text-green-600 border-green-600 hover:bg-green-600 hover:text-white">
                <i class="fa-brands fa-whatsapp fa-xl"></i>
                Enviar mensaje
              </button>
            </div>

            <div class="col-span-2 flex justify-end">
              <button
                [routerLink]="['/products', prod.product.id]"
                class="btn text-blue-500 bg-blue-100 hover:border-blue-500 rounded-lg"
              >
                Volver a comprar
              </button>
            </div>
          </div>

          <!-- ✅ MOBILE (sm) - NUEVO, SOLO PARA PANTALLA PEQUEÑA -->
          <div class="md:hidden px-4 py-4 border-b border-gray-200 last:border-b-0">
            <div class="flex gap-3">
              <img
                class="rounded-md w-20 h-20 object-cover"
                [src]="prod.product.images.at(0)"
                alt="Avatar"
              />

              <div class="flex-1">
                <h3 class="text-green-600 font-semibold text-sm">{{ order.status | titlecase }}</h3>

                @if (order.status === 'pending' || order.status?.toLowerCase() === 'pendiente') {
                  <p class="text-sm text-gray-700">La compra está siendo procesada</p>
                } @else if (order.status === 'enviado') {
                  <p class="text-sm text-gray-700">Su producto fue enviado</p>
                } @else if (order.status === 'entregado') {
                  <p class="text-sm text-gray-700">Su producto fue entregado el 22 de enero de 2025</p>
                }

                <p class="mt-2 text-sm text-gray-500">
                  {{ prod.product.description | titlecase }} - {{ prod.quantity }}
                </p>
                <p class="text-sm text-gray-600">Talla {{ prod.size }}</p>

                <div class="mt-3 text-sm">
                  @if (order.status === 'enviado') {
                    <span class="font-medium">N° Guía: </span>
                    <a
                      class="text-blue-500 underline underline-offset-2"
                      href="https://www.servientrega.com/wps/portal/rastreo-envio"
                      target="_blank"
                      >{{ order.numGuia | uppercase }}</a
                    >
                  } @else {
                    <span class="font-medium">N° Guía:</span> Por confirmar
                  }
                </div>
              </div>
            </div>

            <div class="mt-4 flex flex-col gap-2">
              <button class="btn w-full text-green-600 border-green-600 hover:bg-green-600 hover:text-white">
                <i class="fa-brands fa-whatsapp fa-xl"></i>
                Enviar mensaje
              </button>

              <button
                [routerLink]="['/products', prod.product.id]"
                class="btn w-full text-blue-500 bg-blue-100 hover:border-blue-500 rounded-lg"
              >
                Volver a comprar
              </button>
            </div>
          </div>

        }
      }
    </div>
  }
</section>
